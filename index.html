<script>
  const model = document.querySelector('#model');
  const btn = document.getElementById('playAnimations');
  const loader = document.getElementById('loader');
  const progressBar = document.getElementById('progressBar');
  const loadingText = document.getElementById('loadingText');

  loader.style.display = 'block';
  loadingText.style.display = 'block';

  model.addEventListener('progress', (event) => {
    if (event.detail.totalProgress !== undefined) {
      const percent = Math.floor(event.detail.totalProgress * 100);
      progressBar.style.width = percent + '%';
      loadingText.textContent = `Caricamento modello... ${percent}%`;
    }
  });

  model.addEventListener('load', () => {
    progressBar.style.width = '100%';
    loadingText.textContent = `Caricamento completato!`;

    setTimeout(() => {
      loader.style.display = 'none';
      loadingText.style.display = 'none';
      btn.style.display = 'block';
    }, 500);
  });

  let activeAnimations = [];

  btn.addEventListener('click', () => {
    const animations = model.availableAnimations;
    if (!animations || animations.length === 0) {
      alert('Nessuna animazione disponibile.');
      return;
    }

    // Ferma animazioni precedenti
    activeAnimations.forEach(name => model.pauseAnimation(name));
    activeAnimations = [];

    // Avvia tutte le animazioni e registra quali sono attive
    animations.forEach(name => {
      model.playAnimation(name, false); // false = non in loop
      activeAnimations.push(name);
    });

    btn.style.display = 'none';

    // Calcola la durata massima delle animazioni per sapere quando riabilitare il bottone
    const maxDuration = model.duration ?? 5; // fallback se non definito
    setTimeout(() => {
      btn.style.display = 'block';
    }, maxDuration * 1000);
  });
</script>
